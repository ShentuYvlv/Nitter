<!DOCTYPE html>
<html>
<head>
    <title>推特实时推送</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 1200px; /* 增加最大宽度，以便容纳配置面板 */
            margin: 0 auto;
            padding: 20px;
            background-color: #f7f9fa;
            color: #14171a;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e1e8ed;
            padding-bottom: 10px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #1da1f2;
        }
        
        .status {
            font-size: 14px;
            color: #657786;
        }
        
        .status span {
            font-weight: bold;
        }
        
        .tweet-container {
            margin-top: 20px;
        }
        
        .tweet {
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .tweet.new {
            animation: highlight 2s ease;
        }
        
        @keyframes highlight {
            0% { background-color: #f8f8b0; }
            100% { background-color: white; }
        }
        
        .tweet-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-info {
            margin-left: 10px;
        }
        
        .user-name {
            font-weight: bold;
            font-size: 16px;
            color: #14171a;
            margin: 0;
            text-decoration: none;
        }
        
        .user-id {
            color: #657786;
            font-size: 14px;
            margin: 0;
        }
        
        .tweet-content {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        
        .tweet-footer {
            font-size: 14px;
            color: #657786;
            display: flex;
            justify-content: space-between;
        }
        
        .tweet-time {
            text-decoration: none;
            color: #657786;
        }
        
        .user-filter {
            margin-bottom: 20px;
        }
        
        #user-filter {
            padding: 8px;
            border-radius: 20px;
            border: 1px solid #e1e8ed;
            width: 100%;
            max-width: 300px;
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #657786;
        }
        
        .no-tweets {
            text-align: center;
            padding: 40px 0;
            color: #657786;
            font-size: 18px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #1da1f2;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #1991db;
        }
        
        button:disabled {
            background-color: #9ad0f5;
            cursor: not-allowed;
        }

        .user-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            margin-top: 10px;
            background-color: white;
        }
        
        .user-option {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 1px solid #e1e8ed;
        }
        
        .user-option:hover {
            background-color: #f5f8fa;
        }
        
        .selected-users {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .selected-user {
            background-color: #e8f5fd;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        
        .remove-user {
            margin-left: 8px;
            cursor: pointer;
            color: #657786;
        }
        
        .remove-user:hover {
            color: #e0245e;
        }
        
        .debug-info {
            background-color: #f5f8fa;
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .connection-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .connection-badge.connected {
            background-color: #17bf63;
        }
        
        .connection-badge.disconnected {
            background-color: #e0245e;
        }
        
        .message-container {
            margin: 20px 0;
        }
        
        .message {
            padding: 12px 16px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .message.error {
            background-color: #fde8e8;
            color: #e53e3e;
            border: 1px solid #feb2b2;
        }
        
        .message.warning {
            background-color: #fefcbf;
            color: #d69e2e;
            border: 1px solid #fbd38d;
        }
        
        .message.info {
            background-color: #e6f6ff;
            color: #3182ce;
            border: 1px solid #bee3f8;
        }
        
        /* 添加配置面板样式 */
        .main-container {
            display: flex;
            gap: 20px;
        }
        
        .content-container {
            flex: 1;
        }
        
        .config-panel {
            width: 300px;
            background-color: white;
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .config-panel h2 {
            margin-top: 0;
            font-size: 18px;
            color: #1da1f2;
            border-bottom: 1px solid #e1e8ed;
            padding-bottom: 10px;
            margin-bottom: 16px;
        }
        
        .config-item {
            margin-bottom: 12px;
        }
        
        .config-item label {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
            color: #657786;
        }
        
        .config-item input {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
            font-size: 14px;
        }
        
        .config-item input:focus {
            border-color: #1da1f2;
            outline: none;
        }
        
        .config-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 16px;
        }
        
        .config-actions button {
            flex: 1;
            margin: 0 5px;
        }
        
        .config-actions button:first-child {
            margin-left: 0;
        }
        
        .config-actions button:last-child {
            margin-right: 0;
        }
        
        .config-description {
            font-size: 12px;
            color: #657786;
            margin-top: 4px;
        }
        
        /* 添加图片相关样式 */
        .tweet-avatar {
            margin-right: 10px;
        }
        
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .tweet-images {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .tweet-image {
            max-width: 100%;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .tweet-image img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 12px;
        }
        
        .attachments {
            margin-top: 10px;
        }
        
        .gallery-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .attachment.image {
            max-width: 100%;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .attachment.image img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 12px;
        }
        
        .quote {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            background-color: #f7f9fa;
        }

        /* 统计面板样式 */
        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-item label {
            font-size: 12px;
            color: #657786;
            font-weight: 500;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #14171a;
        }

        .stat-detail {
            font-size: 12px;
            color: #657786;
            font-weight: normal;
        }

        .failed-users-list {
            font-size: 12px;
            color: #e0245e;
            max-height: 100px;
            overflow-y: auto;
            background-color: #fde8e8;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #feb2b2;
        }

        .failed-user-item {
            margin-bottom: 4px;
        }

        .failed-user-item:last-child {
            margin-bottom: 0;
        }

        /* 图片放大功能样式 */
        .tweet-image {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .tweet-image:hover {
            transform: scale(1.05);
        }

        /* 图片放大模态框 */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            cursor: pointer;
        }

        .image-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }

        .image-modal-close:hover {
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>推特实时推送</h1>
        <div class="status">
            状态: <span class="connection-badge" id="connection-badge"></span>
            <span id="connection-status">初始化...</span>
            <span id="user-count"></span>
        </div>
    </div>
    
    <div class="controls">
        <div>
            <button id="toggle-connection">暂停推送</button>
            <button id="clear-tweets">清空推文</button>
            <button id="toggle-debug">调试模式</button>
        </div>
        <div>
            <label for="auto-scroll">
                <input type="checkbox" id="auto-scroll"> 自动滚动
            </label>
        </div>
    </div>
    
    <div class="main-container">
        <div class="content-container">
            <div class="user-filter">
                <input type="text" id="user-filter" placeholder="搜索或添加用户...">
                <div class="user-list" id="user-list" style="display: none;"></div>
                <div class="selected-users" id="selected-users"></div>
            </div>
            
            <div class="tweet-container" id="tweet-container">
                <div class="loading">加载推文中...</div>
            </div>
            
            <div class="message-container" id="message-container"></div>
            
            <div class="debug-info" id="debug-info" style="display: none;"></div>
        </div>
        
        <div class="config-container">
            <div class="config-panel">
                <h2>轮询配置</h2>
                <form id="polling-config-form">
                    <div class="config-item">
                        <label for="priority-poll-interval">优先用户轮询间隔（秒）</label>
                        <input type="number" id="priority-poll-interval" min="1" step="1">
                        <div class="config-description">优先用户组的轮询频率</div>
                    </div>
                    
                    <div class="config-item">
                        <label for="normal-poll-interval">普通用户轮询间隔（秒）</label>
                        <input type="number" id="normal-poll-interval" min="1" step="1">
                        <div class="config-description">普通用户组的轮询频率</div>
                    </div>
                    
                    <div class="config-item">
                        <label for="batch-size">批处理大小</label>
                        <input type="number" id="batch-size" min="1" step="1">
                        <div class="config-description">每批处理的用户数量</div>
                    </div>
                    
                    <div class="config-item">
                        <label for="request-timeout">请求超时（秒）</label>
                        <input type="number" id="request-timeout" min="1" step="1">
                        <div class="config-description">API请求的超时时间</div>
                    </div>
                    
                    <div class="config-item">
                        <label for="max-retries">最大重试次数</label>
                        <input type="number" id="max-retries" min="0" step="1">
                        <div class="config-description">请求失败后的重试次数</div>
                    </div>
                    
                    <div class="config-item">
                        <label for="request-rate">请求速率（每秒）</label>
                        <input type="number" id="request-rate" min="0.1" step="0.1">
                        <div class="config-description">每秒允许的请求数量</div>
                    </div>
                    
                    <div class="config-item">
                        <label for="burst-capacity">突发容量</label>
                        <input type="number" id="burst-capacity" min="1" step="1">
                        <div class="config-description">令牌桶的最大容量</div>
                    </div>
                    
                    <div class="config-actions">
                        <button type="button" id="save-config" class="save-button">保存配置</button>
                        <button type="button" id="reset-config">重置默认</button>
                    </div>
                </form>
            </div>

            <div class="config-panel">
                <h2>轮询统计</h2>
                <div class="stats-container">
                    <div class="stat-item">
                        <label>当前轮次</label>
                        <div class="stat-value" id="current-cycle">-</div>
                    </div>

                    <div class="stat-item">
                        <label>用户统计</label>
                        <div class="stat-value" id="user-stats">
                            <span id="successful-users">0</span>/<span id="total-users">0</span>
                            <span class="stat-detail">(<span id="failed-users">0</span> 失败, <span id="pending-users">0</span> 重试中)</span>
                        </div>
                    </div>

                    <div class="stat-item">
                        <label>成功率</label>
                        <div class="stat-value" id="success-rate">0%</div>
                    </div>

                    <div class="stat-item">
                        <label>上次轮询</label>
                        <div class="stat-value" id="last-cycle-time">-</div>
                    </div>

                    <div class="stat-item" id="failed-users-section" style="display: none;">
                        <label>失败用户</label>
                        <div class="stat-value failed-users-list" id="failed-users-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片放大模态框 -->
    <div id="image-modal" class="image-modal">
        <span class="image-modal-close" id="modal-close">&times;</span>
        <img id="modal-image" class="modal-image" src="" alt="放大图片">
    </div>

    <script>
        // 全局变量
        let eventSource = null;
        let allUsers = [];
        let selectedUsers = [];
        let paused = false;
        let tweets = [];
        const MAX_TWEETS = 500; // 增加最大推文数量，从100增加到500
        let debugMode = false;
        let pollingConfig = {}; // 存储轮询配置
        
        // 获取DOM元素
        const tweetContainer = document.getElementById('tweet-container');
        const messageContainer = document.getElementById('message-container');
        const connectionStatus = document.getElementById('connection-status');
        const connectionBadge = document.getElementById('connection-badge');
        const userCount = document.getElementById('user-count');
        const toggleButton = document.getElementById('toggle-connection');
        const clearButton = document.getElementById('clear-tweets');
        const debugButton = document.getElementById('toggle-debug');
        const autoScrollCheckbox = document.getElementById('auto-scroll');
        const userFilter = document.getElementById('user-filter');
        const userList = document.getElementById('user-list');
        const selectedUsersContainer = document.getElementById('selected-users');
        const debugInfo = document.getElementById('debug-info');
        
        // 调试函数
        function logDebug(message) {
            if (debugMode) {
                const timestamp = new Date().toLocaleTimeString();
                const entry = document.createElement('div');
                entry.textContent = `[${timestamp}] ${message}`;
                debugInfo.appendChild(entry);
                
                // 保持最新消息可见
                debugInfo.scrollTop = debugInfo.scrollHeight;
                
                // 限制调试信息数量
                if (debugInfo.childNodes.length > 100) {
                    debugInfo.removeChild(debugInfo.firstChild);
                }
            }
        }
        
        // 切换调试模式（按Ctrl+Shift+D开启）
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                debugMode = !debugMode;
                debugInfo.style.display = debugMode ? 'block' : 'none';
                logDebug("调试模式 " + (debugMode ? "开启" : "关闭"));
            }
        });
        
        // 加载用户列表
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    allUsers = await response.json();
                    console.log('Loaded users:', allUsers.length);
                    logDebug(`已加载 ${allUsers.length} 个用户`);
                    
                    // 更新用户数量显示
                    userCount.textContent = `(${allUsers.length} 个用户)`;
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                logDebug(`加载用户列表失败: ${error.message}`);
            }
        }
        
        // 处理用户筛选
        userFilter.addEventListener('input', () => {
            const filter = userFilter.value.toLowerCase();
            if (filter.length < 1) {
                userList.style.display = 'none';
                return;
            }
            
            const filtered = allUsers
                .filter(user => {
                    const username = user.username ? user.username.toLowerCase() : '';
                    const userId = user.user_id ? user.user_id.toLowerCase() : '';
                    return username.includes(filter) || userId.includes(filter);
                })
                .slice(0, 10);
            
            userList.innerHTML = '';
            
            if (filtered.length === 0) {
                userList.innerHTML = '<div class="user-option">没有匹配的用户</div>';
            } else {
                filtered.forEach(user => {
                    const option = document.createElement('div');
                    option.className = 'user-option';
                    option.textContent = `${user.username || user.user_id} (@${user.user_id})`;
                    option.addEventListener('click', () => {
                        if (!selectedUsers.includes(user.user_id)) {
                            selectedUsers.push(user.user_id);
                            updateSelectedUsers();
                            updateEventSource();
                        }
                        userFilter.value = '';
                        userList.style.display = 'none';
                    });
                    userList.appendChild(option);
                });
            }
            
            userList.style.display = 'block';
        });
        
        // 点击外部关闭用户列表
        document.addEventListener('click', (event) => {
            if (!userFilter.contains(event.target) && !userList.contains(event.target)) {
                userList.style.display = 'none';
            }
        });
        
        // 更新已选择的用户
        function updateSelectedUsers() {
            selectedUsersContainer.innerHTML = '';
            
            selectedUsers.forEach(userId => {
                const user = allUsers.find(u => u.user_id === userId) || {
                    username: userId,
                    user_id: userId
                };
                
                const element = document.createElement('div');
                element.className = 'selected-user';
                element.innerHTML = `
                    ${user.username || user.user_id} 
                    <span class="remove-user" data-id="${userId}">×</span>
                `;
                selectedUsersContainer.appendChild(element);
            });
            
            // 添加移除用户的事件
            document.querySelectorAll('.remove-user').forEach(btn => {
                btn.addEventListener('click', () => {
                    const userId = btn.getAttribute('data-id');
                    selectedUsers = selectedUsers.filter(id => id !== userId);
                    updateSelectedUsers();
                    updateEventSource();
                });
            });
        }
        
        // 连接到SSE流
        function connectToStream() {
            if (eventSource) {
                eventSource.close();
            }
            
            // 更新连接状态
            updateConnectionStatus('连接中...', 'connecting');
            
            let url = '/api/stream';
            if (selectedUsers.length > 0) {
                url += `?users=${selectedUsers.join(',')}`;
            }
            
            console.log(`连接到SSE流: ${url}`); // 添加控制台日志
            logDebug(`连接到SSE流: ${url}`);
            eventSource = new EventSource(url);
            
            eventSource.onopen = () => {
                console.log('SSE连接已打开'); // 添加控制台日志
                updateConnectionStatus('已连接', 'connected');
                toggleButton.textContent = '暂停推送';
                paused = false;
                logDebug('SSE连接已打开');
            };
            
            eventSource.onerror = (e) => {
                console.error('SSE连接错误:', e); // 添加控制台日志
                updateConnectionStatus('连接错误', 'error');
                logDebug(`SSE连接错误: ${e.toString()}`);
                // 尝试重新连接
                setTimeout(connectToStream, 5000);
            };
            
            eventSource.addEventListener('message', function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    // 记录调试信息
                    logDebug(`接收到消息: ${event.data.substring(0, 100)}...`);
                    
                    // 调试用户信息
                    if (data.user_id && data.username) {
                        logDebug(`推文用户信息: ${data.user_id} -> ${data.username}`);
                    }
                    
                    if (data.type === 'heartbeat') {
                        // 心跳消息，更新状态
                        updateConnectionStatus('已连接', 'connected');
                        return;
                    } else if (data.type === 'connected') {
                        // 连接确认消息
                        updateConnectionStatus('已连接', 'connected');
                        logDebug(`连接确认: ${data.message}`);
                        return;
                    } else if (data.type === 'error') {
                        // 错误消息
                        showMessage('error', data.message);
                        logDebug(`SSE错误: ${data.message}`);
                        return;
                    } else if (data.type === 'warning') {
                        // 警告消息
                        showMessage('warning', data.message);
                        logDebug(`SSE警告: ${data.message}`);
                        return;
                    } else if (data.type === 'info') {
                        // 信息消息
                        showMessage('info', data.message);
                        logDebug(`SSE信息: ${data.message}`);
                        return;
                    } else if (data.type === 'closed') {
                        // 关闭消息
                        logDebug(`SSE关闭: ${data.message}`);
                        return;
                    }
                    
                    // 处理普通推文消息
                    // 移除加载提示
                    const loadingElement = tweetContainer.querySelector('.loading');
                    if (loadingElement) {
                        tweetContainer.removeChild(loadingElement);
                    }
                    
                    // 检查是否已存在相同ID的推文
                    const existingTweetIndex = tweets.findIndex(t => t.id === data.id);
                    
                    if (existingTweetIndex !== -1) {
                        // 如果已存在，更新它
                        tweets[existingTweetIndex] = data;
                    } else {
                        // 添加新推文
                        tweets.unshift(data);
                        
                        // 限制推文数量
                        if (tweets.length > MAX_TWEETS) {
                            tweets = tweets.slice(0, MAX_TWEETS);
                        }
                    }
                    
                    // 记录调试信息
                    logDebug(`渲染推文: ID=${data.id}, 用户=${data.user_id || "未知"}, 用户名=${data.username || "未知"}`);
                    
                    // 更新显示
                    renderTweets();
                } catch (e) {
                    showMessage('error', `处理消息时出错: ${e.message}`);
                    logDebug(`处理SSE消息时出错: ${e.message}`);
                    console.error('Error processing SSE message:', e);
                }
            });
        }
        
        // 更新连接状态
        function updateConnectionStatus(text, state) {
            connectionStatus.textContent = text;
            
            // 更新状态指示器
            if (state === 'connected') {
                connectionBadge.className = 'connection-badge connected';
                connectionStatus.style.color = '#17bf63';
            } else if (state === 'error') {
                connectionBadge.className = 'connection-badge disconnected';
                connectionStatus.style.color = '#e0245e';
            } else {
                connectionBadge.className = 'connection-badge';
                connectionStatus.style.color = '#657786';
            }
        }
        
        // 更新事件源
        function updateEventSource() {
            if (!paused) {
                connectToStream();
            }
        }
        
        // 格式化日期，处理无效日期
        function formatDate(dateStr) {
            if (!dateStr) return "未知日期";
            
            try {
                // 尝试处理常见的RFC 822/1123格式 (Twitter API常用格式)
                // 例如: "Wed, 09 May 2025 15:20:15 GMT"
                const date = new Date(dateStr);
                
                // 检查日期是否有效
                if (isNaN(date.getTime())) {
                    logDebug(`无效日期格式: ${dateStr}`);
                    return "未知日期";
                }
                
                // 格式化日期为本地时间
                const options = { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                return date.toLocaleDateString(undefined, options);
            } catch (e) {
                logDebug(`日期解析错误: ${e.message}`);
                return "未知日期";
            }
        }
        
        // 渲染推文列表
        function renderTweets() {
            if (tweets.length === 0) {
                tweetContainer.innerHTML = '<div class="no-tweets">还没有任何推文</div>';
                return;
            }
            
            tweetContainer.innerHTML = '';
            
            // 过滤选定用户的推文
            let filteredTweets = tweets;
            if (selectedUsers.length > 0) {
                filteredTweets = tweets.filter(tweet => {
                    const tweetUserId = tweet.user_id || "";
                    return selectedUsers.includes(tweetUserId);
                });
            }
            
            if (filteredTweets.length === 0) {
                tweetContainer.innerHTML = '<div class="no-tweets">没有匹配的推文</div>';
                return;
            }
            
            // 创建推文元素
            filteredTweets.forEach((tweet, index) => {
                const tweetElement = document.createElement('div');
                tweetElement.className = 'tweet';
                if (index === 0) {
                    tweetElement.classList.add('new');
                }
                
                // 安全获取推文数据
                const userId = tweet.user_id || "未知用户";
                const content = tweet.content || "无内容";
                const html = tweet.html || "";
                const publishedAt = tweet.published_at || "";
                const url = tweet.url || "#";
                
                // 记录调试信息
                logDebug(`渲染推文: ID=${tweet.id}, 用户=${userId}, 用户名=${tweet.username || "未知"}`);
                
                // 格式化日期
                const formattedDate = formatDate(publishedAt);
                
                // 直接使用推文中的用户信息
                const displayName = tweet.username || userId;
                const profileImage = tweet.profile_image || "";
                
                // 提取图片 - 优先使用 tweet.images 字段
                let imagesHtml = '';
                let imageUrls = [];

                // 首先检查 tweet.images 字段
                logDebug(`tweet.images 类型: ${typeof tweet.images}, 值: ${JSON.stringify(tweet.images)}`);

                if (tweet.images) {
                    if (typeof tweet.images === 'string') {
                        try {
                            imageUrls = JSON.parse(tweet.images);
                            logDebug(`从字符串解析图片: ${JSON.stringify(imageUrls)}`);
                        } catch (e) {
                            logDebug(`解析图片字符串失败: ${e}, 原始值: ${tweet.images}`);
                            imageUrls = [];
                        }
                    } else if (Array.isArray(tweet.images)) {
                        imageUrls = tweet.images;
                        logDebug(`直接使用图片数组: ${JSON.stringify(imageUrls)}`);
                    }
                }

                // 如果没有从 tweet.images 获取到图片，再从HTML中提取
                if (imageUrls.length === 0 && html) {
                    // 创建一个临时元素来解析HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;

                    // 记录调试信息
                    logDebug(`解析HTML内容: ${html.substring(0, 200)}...`);

                    // 查找所有图片
                    const images = tempDiv.querySelectorAll('img');
                    logDebug(`从HTML找到 ${images.length} 张图片`);
                    
                    if (images.length > 0) {
                        images.forEach(img => {
                            const imgSrc = img.getAttribute('src');
                            logDebug(`从HTML提取图片URL: ${imgSrc}`);

                            // 过滤掉头像图片和空URL
                            if (imgSrc &&
                                !imgSrc.includes('profile_images') &&
                                !imgSrc.includes('_mini.') &&
                                !imgSrc.includes('_normal.')) {
                                imageUrls.push(imgSrc);
                            }
                        });
                    }
                }

                // 处理图片URL数组
                if (imageUrls.length > 0) {
                    logDebug(`总共找到 ${imageUrls.length} 张图片: ${JSON.stringify(imageUrls)}`);
                    imagesHtml = '<div class="tweet-images">';

                    imageUrls.forEach((imgSrc, index) => {
                        if (imgSrc) {
                            logDebug(`处理图片 ${index + 1}: ${imgSrc}`);

                            // 修复图片URL
                            let fixedSrc = imgSrc;

                            // 修复端口号问题
                            if (imgSrc.startsWith('http://localhost/') && !imgSrc.includes(':8080')) {
                                fixedSrc = imgSrc.replace('http://localhost/', 'http://localhost:8080/');
                                logDebug(`修复端口号: ${imgSrc} -> ${fixedSrc}`);
                            }

                            // 处理相对URL
                            if (imgSrc.startsWith('/')) {
                                try {
                                    let baseUrl = '';
                                    if (url && url !== '#') {
                                        const urlObj = new URL(url);
                                        baseUrl = urlObj.origin;
                                    } else {
                                        baseUrl = window.location.origin;
                                    }
                                    fixedSrc = `${baseUrl}${imgSrc}`;
                                    logDebug(`修复相对URL: ${imgSrc} -> ${fixedSrc}`);
                                } catch (e) {
                                    logDebug(`处理URL时出错: ${e.message}`);
                                    fixedSrc = `${window.location.origin}${imgSrc}`;
                                }
                            }

                            imagesHtml += `<div class="tweet-image">
                                <img src="${fixedSrc}" alt="推文图片" loading="lazy" class="tweet-image clickable-image"
                                     onerror="console.error('图片加载失败:', this.src); this.style.display='none';"
                                     onload="console.log('图片加载成功:', this.src);"
                                     onclick="openImageModal('${fixedSrc}')">
                            </div>`;
                        }
                    });

                    imagesHtml += '</div>';
                } else {
                    logDebug('推文不包含图片');
                }

                // 构建推文HTML
                tweetElement.innerHTML = `
                    <div class="tweet-header">
                        ${profileImage ? `<a class="tweet-avatar" href="https://twitter.com/${userId}" target="_blank">
                            <img class="avatar" src="${profileImage}" alt="${displayName}" loading="lazy">
                        </a>` : ''}
                        <div class="user-info">
                            <a href="https://twitter.com/${userId}" target="_blank" class="user-name">
                                ${displayName}
                            </a>
                            <p class="user-id">@${userId}</p>
                        </div>
                    </div>
                    <div class="tweet-content">${content}</div>
                    ${imagesHtml}
                    <div class="tweet-footer">
                        <a href="${url}" target="_blank" class="tweet-time">${formattedDate}</a>
                    </div>
                `;
                
                tweetContainer.appendChild(tweetElement);
            });
            
            // 自动滚动到顶部
            if (autoScrollCheckbox.checked) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // 添加显示消息的函数
        function showMessage(type, text) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = text;
            
            // 添加关闭按钮
            const closeButton = document.createElement('span');
            closeButton.innerHTML = '&times;';
            closeButton.style.float = 'right';
            closeButton.style.cursor = 'pointer';
            closeButton.style.fontWeight = 'bold';
            closeButton.onclick = function() {
                messageContainer.removeChild(messageElement);
            };
            
            messageElement.appendChild(closeButton);
            messageContainer.appendChild(messageElement);
            
            // 记录到调试日志
            logDebug(`${type.toUpperCase()}: ${text}`);
        }
        
        // 加载轮询配置
        async function loadPollingConfig() {
            try {
                const response = await fetch('/api/polling-config');
                if (response.ok) {
                    pollingConfig = await response.json();
                    console.log('加载轮询配置:', pollingConfig);
                    logDebug(`已加载轮询配置`);
                    
                    // 更新表单
                    document.getElementById('priority-poll-interval').value = pollingConfig.PRIORITY_POLL_INTERVAL || '';
                    document.getElementById('normal-poll-interval').value = pollingConfig.NORMAL_POLL_INTERVAL || '';
                    document.getElementById('batch-size').value = pollingConfig.BATCH_SIZE || '';
                    document.getElementById('request-timeout').value = pollingConfig.REQUEST_TIMEOUT || '';
                    document.getElementById('max-retries').value = pollingConfig.MAX_RETRIES || '';
                    document.getElementById('request-rate').value = pollingConfig.REQUEST_RATE || '';
                    document.getElementById('burst-capacity').value = pollingConfig.BURST_CAPACITY || '';
                } else {
                    showMessage('error', '加载轮询配置失败');
                    logDebug(`加载轮询配置失败: ${response.status}`);
                }
            } catch (error) {
                console.error('加载轮询配置出错:', error);
                showMessage('error', `加载轮询配置出错: ${error.message}`);
                logDebug(`加载轮询配置出错: ${error.message}`);
            }
        }
        
        // 保存轮询配置
        async function savePollingConfig() {
            try {
                // 获取表单数据
                const config = {
                    PRIORITY_POLL_INTERVAL: parseInt(document.getElementById('priority-poll-interval').value, 10),
                    NORMAL_POLL_INTERVAL: parseInt(document.getElementById('normal-poll-interval').value, 10),
                    BATCH_SIZE: parseInt(document.getElementById('batch-size').value, 10),
                    REQUEST_TIMEOUT: parseInt(document.getElementById('request-timeout').value, 10),
                    MAX_RETRIES: parseInt(document.getElementById('max-retries').value, 10),
                    REQUEST_RATE: parseFloat(document.getElementById('request-rate').value),
                    BURST_CAPACITY: parseInt(document.getElementById('burst-capacity').value, 10)
                };
                
                // 验证数据
                for (const key in config) {
                    if (isNaN(config[key]) || config[key] <= 0) {
                        showMessage('error', `${key} 必须是正数`);
                        return;
                    }
                }
                
                // 发送请求
                const response = await fetch('/api/polling-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    pollingConfig = result;
                    showMessage('info', '配置已保存，将在下一轮轮询时生效');
                    logDebug('轮询配置已保存');
                } else {
                    const error = await response.json();
                    showMessage('error', `保存配置失败: ${error.error || '未知错误'}`);
                    logDebug(`保存轮询配置失败: ${JSON.stringify(error)}`);
                }
            } catch (error) {
                console.error('保存轮询配置出错:', error);
                showMessage('error', `保存轮询配置出错: ${error.message}`);
                logDebug(`保存轮询配置出错: ${error.message}`);
            }
        }
        
        // 重置轮询配置为默认值
        function resetPollingConfig() {
            document.getElementById('priority-poll-interval').value = 10;
            document.getElementById('normal-poll-interval').value = 60;
            document.getElementById('batch-size').value = 15;
            document.getElementById('request-timeout').value = 10;
            document.getElementById('max-retries').value = 5;
            document.getElementById('request-rate').value = 10;
            document.getElementById('burst-capacity').value = 20;

            // 提示用户需要点击保存
            showMessage('info', '已重置为默认值，请点击保存按钮应用更改');
            logDebug('轮询配置已重置为默认值');
        }

        // 加载轮询统计
        async function loadPollingStats() {
            try {
                const response = await fetch('/api/polling-stats');
                if (response.ok) {
                    const stats = await response.json();
                    updateStatsDisplay(stats);
                } else {
                    logDebug('加载轮询统计失败');
                }
            } catch (error) {
                console.error('Failed to load polling stats:', error);
                logDebug(`加载轮询统计出错: ${error.message}`);
            }
        }

        // 更新统计显示
        function updateStatsDisplay(stats) {
            document.getElementById('current-cycle').textContent = stats.current_cycle || '-';
            document.getElementById('successful-users').textContent = stats.successful_users || 0;
            document.getElementById('total-users').textContent = stats.total_users || 0;
            document.getElementById('failed-users').textContent = stats.failed_users || 0;

            // 显示待重试用户数
            const pendingUsers = stats.pending_users || 0;
            const pendingElement = document.getElementById('pending-users');
            if (pendingElement) {
                pendingElement.textContent = pendingUsers;
            }

            const successRate = stats.success_rate || 0;
            document.getElementById('success-rate').textContent = `${(successRate * 100).toFixed(1)}%`;

            if (stats.last_cycle_time) {
                const lastTime = new Date(stats.last_cycle_time);
                document.getElementById('last-cycle-time').textContent = lastTime.toLocaleTimeString();
            } else {
                document.getElementById('last-cycle-time').textContent = '-';
            }

            // 显示失败用户列表
            const failedUsersSection = document.getElementById('failed-users-section');
            const failedUsersList = document.getElementById('failed-users-list');

            if (stats.failed_user_list && stats.failed_user_list.length > 0) {
                failedUsersSection.style.display = 'block';
                failedUsersList.innerHTML = '';

                stats.failed_user_list.forEach(userId => {
                    const item = document.createElement('div');
                    item.className = 'failed-user-item';
                    item.textContent = userId;
                    failedUsersList.appendChild(item);
                });
            } else {
                failedUsersSection.style.display = 'none';
            }
        }

        // 图片放大功能
        function openImageModal(imageSrc) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');

            modalImage.src = imageSrc;
            modal.classList.add('show');

            // 阻止页面滚动
            document.body.style.overflow = 'hidden';

            logDebug(`打开图片放大: ${imageSrc}`);
        }

        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.remove('show');

            // 恢复页面滚动
            document.body.style.overflow = 'auto';

            logDebug('关闭图片放大');
        }

        // 初始化
        async function init() {
            logDebug('初始化应用...');
            await loadUsers();
            await loadPollingConfig(); // 加载轮询配置
            await loadPollingStats(); // 加载轮询统计

            // 设置定期更新统计（每30秒）
            setInterval(loadPollingStats, 30000);

            // 连接事件流
            connectToStream();
            
            // 添加事件监听器
            toggleButton.addEventListener('click', () => {
                if (paused) {
                    connectToStream();
                    toggleButton.textContent = '暂停推送';
                } else {
                    if (eventSource) {
                        eventSource.close();
                        updateConnectionStatus('已暂停', 'paused');
                    }
                    toggleButton.textContent = '恢复推送';
                }
                paused = !paused;
                logDebug(`推送状态已变更为: ${paused ? '已暂停' : '已恢复'}`);
            });
            
            clearButton.addEventListener('click', () => {
                tweets = [];
                renderTweets();
                logDebug('已清空推文列表');
            });
            
            debugButton.addEventListener('click', () => {
                debugMode = !debugMode;
                debugInfo.style.display = debugMode ? 'block' : 'none';
                logDebug("调试模式 " + (debugMode ? "开启" : "关闭"));
            });
            
            // 添加配置面板事件监听器
            document.getElementById('save-config').addEventListener('click', savePollingConfig);
            document.getElementById('reset-config').addEventListener('click', resetPollingConfig);

            // 添加图片模态框事件监听器
            const imageModal = document.getElementById('image-modal');
            const modalClose = document.getElementById('modal-close');

            // 点击关闭按钮
            modalClose.addEventListener('click', closeImageModal);

            // 点击模态框背景关闭
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    closeImageModal();
                }
            });

            // ESC键关闭
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && imageModal.classList.contains('show')) {
                    closeImageModal();
                }
            });
        }
        
        // 启动应用
        init();
    </script>
</body>
</html>
